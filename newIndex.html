<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script type="text/javascript" src="https://vncdn.mobi88.cn/public/jquery-2.1.3.min.js"></script>
    <script src="./js/pxloader-all.min.js"></script>
    <script src="./js/PxLoaderImage.js"></script>
    <style>
        body {
            margin: 0;
            background-color: #131313;
            overflow-x: hidden;
        }

        #sticky {
            top: 0;
            width: 100%;
            overflow-x: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #131313;
        }

        canvas {
            position: relative;
        }

        p.left,
        p.right {
            font-size: 28px;
            color: #fff;
            font-family: Arial, Helvetica, sans-serif;
            font-weight: bold;
            position: absolute;
            top: 45%;
            opacity: 0;
        }

        p.left {
            left: 50%;
        }

        p.right {
            right: 50%;
        }

        #loading {
            font-size: 28px;
            font-family: Arial, Helvetica, sans-serif;
            color: #fff;
            position: absolute;
            width: 45vw;
            text-align: center;
            z-index: 10;
            font-weight: bold;
            background: url('https://s3-us-west-2.amazonaws.com/s.cdpn.io/2002878/iphone-se.01.png') no-repeat center center;
            background-size: contain;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: -50px;
            transition: .5s opacity ease-in-out;
            transition-delay: 2s;
        }

        #loading p {
            margin-top: 40%;
        }

        /* #loading{
            opacity: 0;
        } */
    </style>
</head>

<body>
    <div id="loaded">
        <video src="img/触摸灯.mp4" muted autoplay loop class="homeVideo"></video>
        <div id="sticky">
            <canvas id="iphone-se" width="432" height="976"></canvas>
            <p class="left">
                Durable glass and<br>aluminum design
            </p>
            <p class="right">
                Brilliant 4.7<br>aluminum design
            </p>
            <!-- <div id="loading">
                <p>正在加载中....</p>
            </div> -->
        </div>
        <video src="img/触摸灯.mp4" muted autoplay loop class="homeVideo"></video>
    </div>
</body>
<script>
    $(function () {
        $('#iphone-se').height($(window).height())
        // $('html,body').animate({scrollTop:0});  
    })
    $(window).on('scroll', function () {
        console.log(document.documentElement.scrollTop)
        console.log(document.getElementById('sticky').offsetTop)

        if (document.documentElement.scrollTop >= 1080 && document.documentElement.scrollTop < 1200) {
            $('#sticky')[0].style.position = 'fixed';
            $('#sticky')[0].style.top = '0';
        }
        let scrolled = document.documentElement.scrollTop / (document.documentElement.scrollHeight - document.documentElement.clientHeight)
        let Dome =  $('#sticky')[0];
        console.log(isElementInViewport(Dome))
        if(isElementInViewport(Dome)){
            let frame = Math.ceil(scrolled * 84)
            changeFrame(frame)
        }
        // moveDevice($('#iphone-se'), scrolled, 0.3, 0.6, 0.6, 1)
        showHideText($('.left'), scrolled, 0.45, 0.52, 0.58, 0.65)
        showHideText($('.right'), scrolled, 0.9, 1)
    })

    const loader = new PxLoader()
    const images = [];

    for (let i = 0; i < 85; i++) {
        images[i] = loader.addImage(`https://s3-us-west-2.amazonaws.com/s.cdpn.io/2002878/iphone-se.${('0' + (i + 1)).slice(-2)}.png`)
    }

    loader.addCompletionListener(function () {
        let context = $('#iphone-se')[0].getContext('2d')
        context.drawImage(images[0], 0, 0, 432, 976)
    })
    loader.start();

    function changeFrame(frame) {
        let index = frame - 1;
        console.log(index)
        if (index < 0) {
            index = 0;
            $('#sticky')[0].style.position = 'inherit';
        }
        if (index > 84) {
            index = 84;

        }
        if (index >= 83) {
            $('#sticky')[0].style.position = 'inherit';
        }

        let context = $('#iphone-se')[0].getContext('2d')
        context.drawImage(images[index], 0, 0, 432, 976)
    }

    function moveDevice(el, current, toLeftFrom, toLeftTo, toRightFrom, toRightTo) {
        if (current <= toLeftTo) {
            if (current >= toLeftFrom) {
                let offsetRatio = (current - toLeftFrom) / (toLeftTo - toLeftFrom)
                $('#iphone-se').css('left', $('#iphone-se').width() / 2 * -1 * offsetRatio)

            }
        } else {
            let offsetRatio = (current - toRightFrom) / (toRightTo - toRightFrom)
            $('#iphone-se').css('left', $('#iphone-se').width() / 2 * -1 + $('#iphone-se').width() * offsetRatio)
        }
    }

    function showHideText(el, current, showFrom, showTo, hideFrom, hideTo) {
        if (current < showFrom) {
            $(el).css('opacity', 0)
        }
        if (current >= showFrom && current <= showTo) {
            $(el).css('opacity', (current - showFrom) / (showTo - showFrom))
        }
        if (typeof hideFrom !== 'undefined' && typeof hideTo !== 'undefined') {
            if (current > hideFrom && current <= hideTo) {
                $(el).css('opacity', (hideTo - current) / (hideTo - hideFrom))
            }
            if (current > hideTo) {
                $(el).css('opacity', 0)
            }
        }
    }

    function isElementInViewport(el) {
        //获取元素是否在可视区域
        var rect = el.getBoundingClientRect();
        return (
            rect.top >= 0 &&
            rect.left >= 0 &&
            rect.bottom <=
            (window.innerHeight || document.documentElement.clientHeight) &&
            rect.right <=
            (window.innerWidth || document.documentElement.clientWidth)
        );
    }
</script>

</html>